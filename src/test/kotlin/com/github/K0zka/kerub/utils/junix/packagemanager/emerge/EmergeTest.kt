package com.github.K0zka.kerub.utils.junix.packagemanager.emerge

import com.github.K0zka.kerub.model.SoftwarePackage
import com.github.K0zka.kerub.model.Version
import com.nhaarman.mockito_kotlin.any
import com.nhaarman.mockito_kotlin.mock
import com.nhaarman.mockito_kotlin.whenever
import org.apache.commons.io.input.NullInputStream
import org.apache.sshd.client.channel.ChannelExec
import org.apache.sshd.client.future.OpenFuture
import org.apache.sshd.client.session.ClientSession
import org.junit.Test
import java.io.ByteArrayInputStream
import kotlin.test.assertEquals
import kotlin.test.assertTrue

class EmergeTest {

	val session: ClientSession = mock()
	val execChannel: ChannelExec = mock()
	val openFuture: OpenFuture = mock()

	val output =
			"""app-admin/eselect-1.4.5
app-admin/perl-cleaner-2.20
app-admin/setools-4.0.1
app-admin/sysklogd-1.5.1
app-admin/sysstat-11.4.0
app-arch/bzip2-1.0.6-r7
app-arch/cpio-2.12-r1
app-arch/gzip-1.8
app-arch/libarchive-3.2.2
app-arch/lz4-0_p131
app-arch/snappy-1.1.3-r1
app-arch/tar-1.29-r1
app-arch/unzip-6.0_p20
app-arch/xz-utils-5.2.2
app-benchmarks/bonnie++-1.97-r1
app-editors/nano-2.5.3
app-editors/vim-8.0.0106
app-editors/vim-core-8.0.0106
app-emulation/libvirt-2.3.0
app-emulation/qemu-2.7.0-r7
app-eselect/eselect-ctags-1.18
app-eselect/eselect-python-20140125-r2
app-eselect/eselect-vi-1.1.7-r1
app-misc/ca-certificates-20151214.3.21
app-misc/c_rehash-1.7-r1
app-misc/editor-wrapper-4
app-misc/mime-types-9
app-misc/pax-utils-1.1.6
app-misc/scrub-2.5.2
app-portage/portage-utils-0.62
app-shells/bash-4.3_p48-r1
app-text/build-docbook-catalog-1.19.1
app-text/docbook-xml-dtd-4.1.2-r6
app-text/docbook-xsl-stylesheets-1.79.0
app-text/manpager-1
app-text/openjade-1.3.2-r6
app-text/opensp-1.5.2-r3
app-text/po4a-0.45-r3
app-text/sgml-common-0.6.3-r5
app-text/xhtml1-20020801-r4
app-vim/gentoo-syntax-20160530
dev-db/sqlite-3.13.0
dev-lang/ghc-7.10.3
dev-lang/nasm-2.12.01
dev-lang/perl-5.22.3_rc4
dev-lang/python-2.7.12
dev-lang/python-3.4.5
dev-lang/python-exec-2.0.2
dev-lang/swig-3.0.8
dev-libs/boost-1.56.0-r1
dev-libs/elfutils-0.166
dev-libs/expat-2.2.0-r1
dev-libs/fcgi-2.4.1_pre0910052249-r2
dev-libs/glib-2.48.2
dev-libs/gmp-6.1.0
dev-libs/iniparser-3.1-r1
dev-libs/leveldb-1.18-r1
dev-libs/libaio-0.3.110
dev-libs/libffi-3.2.1
dev-libs/libgcrypt-1.7.3
dev-libs/libgpg-error-1.24
dev-libs/libltdl-2.4.6
dev-libs/libnl-3.2.28
dev-libs/libpcre-8.39
dev-libs/libpipeline-1.4.0
dev-libs/libtasn1-4.9-r1
dev-libs/libxml2-2.9.4
dev-libs/libxslt-1.1.29
dev-libs/mpc-1.0.2-r1
dev-libs/mpfr-3.1.3_p4
dev-libs/nettle-3.2-r1
dev-libs/nspr-4.12
dev-libs/nss-3.23
dev-libs/openssl-1.0.2j
dev-libs/popt-1.16-r2
dev-libs/ustr-1.0.4-r8
dev-libs/yajl-2.1.0
dev-perl/libintl-perl-1.240.0
dev-perl/Locale-gettext-1.50.0-r1
dev-perl/Module-Build-0.421.600
dev-perl/SGMLSpm-1.03-r7
dev-perl/TermReadKey-2.330.0
dev-perl/Text-CharWidth-0.40.0-r1
dev-perl/Text-Unidecode-1.270.0
dev-perl/Text-WrapI18N-0.60.0-r1
dev-perl/Unicode-EastAsianWidth-1.330.0-r1
dev-perl/XML-Parser-2.440.0
dev-perl/XML-XPath-1.130.0-r1
dev-python/alabaster-0.7.6
dev-python/Babel-2.3.4
dev-python/backports-1.0
dev-python/backports-ssl-match-hostname-3.5.0.1-r1
dev-python/blinker-1.3
dev-python/certifi-2016.9.26
dev-python/cffi-1.5.2
dev-python/chardet-2.3.0
dev-python/cryptography-1.5.2
dev-python/cython-0.24.1
dev-python/decorator-4.0.2
dev-python/docutils-0.12
dev-python/enum34-1.0.4
dev-python/flask-0.10.1-r1
dev-python/idna-2.0
dev-python/ipaddress-1.0.14
dev-python/ipy-0.82a
dev-python/itsdangerous-0.24
dev-python/jinja-2.8
dev-python/markupsafe-0.23
dev-python/ndg-httpsclient-0.4.0
dev-python/networkx-1.10-r1
dev-python/ply-3.6-r1
dev-python/py-1.4.30
dev-python/pyasn1-0.1.8
dev-python/pycparser-2.14
dev-python/pygments-2.1.1
dev-python/pyopenssl-16.1.0
dev-python/pypax-0.9.2
dev-python/PySocks-1.5.6
dev-python/pytz-2016.3
dev-python/pyxattr-0.5.5
dev-python/requests-2.11.1
dev-python/sepolgen-2.6
dev-python/setuptools-20.6.7
dev-python/simplejson-3.10.0
dev-python/six-1.10.0
dev-python/snowballstemmer-1.2.0
dev-python/sphinx-1.3.1-r1
dev-python/sphinx_rtd_theme-0.1.9
dev-python/urllib3-1.16
dev-python/werkzeug-0.9.6
dev-scheme/guile-1.8.8-r3
dev-util/boost-build-1.56.0
dev-util/cmake-3.6.3
dev-util/ctags-20161028
dev-util/google-perftools-2.0-r2
dev-util/gperf-3.0.4
dev-util/gtk-doc-am-1.25-r1
dev-util/intltool-0.51.0-r1
dev-util/pkgconfig-0.28-r2
media-libs/freetype-2.6.3-r1
media-libs/libjpeg-turbo-1.5.0
media-libs/libpng-1.6.25
net-analyzer/netcat6-1.0-r2
net-dns/libidn-1.33
net-firewall/iptables-1.4.21-r1
net-libs/gnutls-3.3.24-r1
net-libs/libmnl-1.0.4
net-libs/libssh2-1.7.0
net-misc/curl-7.52.1-r1
net-misc/dhcpcd-6.11.3
net-misc/iputils-20151218
net-misc/netifrc-0.5.1
net-misc/openssh-7.3_p1-r7
net-misc/rsync-3.1.2
net-misc/wget-1.18
perl-core/File-Temp-0.230.400-r1
sec-policy/selinux-base-2.20161023-r1
sec-policy/selinux-base-policy-2.20161023-r1
sec-policy/selinux-dmidecode-2.20161023-r1
sec-policy/selinux-mandb-2.20161023-r1
sec-policy/selinux-openrc-2.20161023-r1
sec-policy/selinux-qemu-2.20161023-r1
sec-policy/selinux-shutdown-2.20161023-r1
sec-policy/selinux-sysstat-2.20161023-r1
sec-policy/selinux-unconfined-2.20161023-r1
sec-policy/selinux-virt-2.20161023-r1
sys-apps/acl-2.2.52-r1
sys-apps/attr-2.4.47-r2
sys-apps/baselayout-2.3
sys-apps/busybox-1.25.1
sys-apps/checkpolicy-2.6
sys-apps/coreutils-8.25
sys-apps/debianutils-4.7
sys-apps/diffutils-3.3
sys-apps/dmidecode-2.12-r1
sys-apps/dtc-1.4.1
sys-apps/elfix-0.9.2
sys-apps/ethtool-3.18
sys-apps/file-5.25
sys-apps/findutils-4.6.0-r1
sys-apps/gawk-4.1.3
sys-apps/gentoo-functions-0.10
sys-apps/gptfdisk-1.0.1
sys-apps/grep-2.25
sys-apps/groff-1.22.2
sys-apps/hdparm-9.48
sys-apps/help2man-1.46.6
sys-apps/hwids-20150717-r1
sys-apps/install-xattr-0.5
sys-apps/iproute2-4.4.0
sys-apps/kbd-2.0.3
sys-apps/keyutils-1.5.9-r1
sys-apps/kmod-22
sys-apps/less-481
sys-apps/lsb-release-1.4
sys-apps/man-db-2.7.5
sys-apps/man-pages-4.08
sys-apps/man-pages-posix-2013a
sys-apps/net-tools-1.60_p20160215155418
sys-apps/openrc-0.22.4
sys-apps/paxctl-0.9
sys-apps/pciutils-3.4.1
sys-apps/policycoreutils-2.6
sys-apps/portage-2.3.0
sys-apps/pv-1.6.0-r1
sys-apps/sandbox-2.10-r1
sys-apps/sed-4.2.2
sys-apps/shadow-4.2.1-r2
sys-apps/sysvinit-2.88-r9
sys-apps/texinfo-6.1
sys-apps/util-linux-2.26.2
sys-apps/which-2.21
sys-auth/pambase-20150213
sys-block/fio-2.15
sys-block/open-iscsi-2.0.873-r1
sys-block/parted-3.2
sys-block/thin-provisioning-tools-0.4.1
sys-boot/efibootmgr-0.12
sys-boot/grub-2.02_beta3-r1
sys-devel/autoconf-2.69
sys-devel/autoconf-wrapper-13
sys-devel/autogen-5.18.4
sys-devel/automake-1.14.1
sys-devel/automake-1.15
sys-devel/automake-wrapper-10
sys-devel/bc-1.06.95-r1
sys-devel/bin86-0.16.21
sys-devel/binutils-2.25.1-r1
sys-devel/binutils-config-5-r2
sys-devel/bison-3.0.4-r1
sys-devel/dev86-0.16.19
sys-devel/flex-2.6.1
sys-devel/gcc-4.9.3
sys-devel/gcc-4.9.4
sys-devel/gcc-config-1.7.3
sys-devel/gettext-0.19.7
sys-devel/gnuconfig-20160402
sys-devel/libtool-2.4.6-r2
sys-devel/m4-1.4.17
sys-devel/make-4.1-r1
sys-devel/patch-2.7.5
sys-firmware/ipxe-1.0.0_p20160620
sys-firmware/seabios-1.8.2
sys-firmware/sgabios-0.1_pre8
sys-firmware/vgabios-0.7a
sys-fs/cryptsetup-1.7.2
sys-fs/e2fsprogs-1.43.3-r1
sys-fs/eudev-3.1.5
sys-fs/lsscsi-0.28
sys-fs/lvm2-2.02.116-r4
sys-fs/udev-init-scripts-27
sys-kernel/gentoo-sources-4.4.26
sys-kernel/linux-firmware-20160331
sys-kernel/linux-headers-4.4
sys-libs/cracklib-2.9.6-r1
sys-libs/db-4.8.30-r2
sys-libs/db-5.3.28-r2
sys-libs/e2fsprogs-libs-1.43.3
sys-libs/efivar-0.21
sys-libs/gdbm-1.11
sys-libs/glibc-2.22-r4
sys-libs/libcap-2.24-r2
sys-libs/libcap-ng-0.7.7
sys-libs/libseccomp-2.3.0
sys-libs/libselinux-2.6
sys-libs/libsemanage-2.6
sys-libs/libsepol-2.6
sys-libs/libunwind-1.1-r1
sys-libs/ncurses-6.0-r1
sys-libs/pam-1.2.1
sys-libs/readline-6.3_p8-r3
sys-libs/timezone-data-2016h
sys-libs/zlib-1.2.8-r1
sys-process/audit-2.6.4
sys-process/procps-3.3.12
sys-process/psmisc-22.21-r3
virtual/acl-0-r2
virtual/dev-manager-0
virtual/editor-0
virtual/jpeg-0-r2
virtual/libc-1
virtual/libffi-3.0.13-r1
virtual/libiconv-0-r2
virtual/libintl-0-r2
virtual/libudev-215-r1
virtual/linux-sources-1
virtual/man-0-r1
virtual/modutils-0
virtual/os-headers-0
virtual/package-manager-0
virtual/pager-0
virtual/pam-0-r1
virtual/perl-CPAN-Meta-2.150.1-r1
virtual/perl-CPAN-Meta-YAML-0.12.0-r2
virtual/perl-Data-Dumper-2.158.0-r1
virtual/perl-ExtUtils-CBuilder-0.280.221-r1
virtual/perl-ExtUtils-Install-2.40.0-r2
virtual/perl-ExtUtils-MakeMaker-7.40.100_rc-r2
virtual/perl-ExtUtils-Manifest-1.700.0-r3
virtual/perl-ExtUtils-ParseXS-3.280.0-r1
virtual/perl-File-Spec-3.560.100-r1
virtual/perl-File-Temp-0.230.400-r5
virtual/perl-Getopt-Long-2.450.0-r1
virtual/perl-JSON-PP-2.273.0-r4
virtual/perl-Module-Metadata-1.0.26-r1
virtual/perl-Parse-CPAN-Meta-1.441.400-r3
virtual/perl-Perl-OSType-1.8.0-r1
virtual/perl-Test-Harness-3.350.100_rc
virtual/perl-Text-ParseWords-3.300.0-r2
virtual/perl-version-0.990.900-r3
virtual/pkgconfig-0-r1
virtual/python-ipaddress-1.0-r1
virtual/service-manager-0
virtual/shadow-0
virtual/ssh-0
virtual/udev-215
virtual/yacc-0
x11-libs/libpciaccess-0.13.4
x11-libs/pixman-0.34.0
x11-misc/shared-mime-info-1.4
"""

	@Test
	fun listPackages() {
		whenever(session.createExecChannel(any())).thenReturn(execChannel)
		whenever(execChannel.open()).thenReturn(openFuture)
		whenever(execChannel.invertedErr).thenReturn(NullInputStream(0))
		whenever(execChannel.invertedOut).then { ByteArrayInputStream(output.toByteArray()) }

		val list = Emerge.listPackages(session)

		assertEquals(output.lines().size, list.size)
		assertTrue { list.contains(SoftwarePackage("ssh", Version("0", null, null))) }
		assertTrue { list.contains(SoftwarePackage("libpciaccess", Version("0", "13", "4"))) }
	}

}